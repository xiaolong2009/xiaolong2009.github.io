<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      由WSGI想到的 &middot; V2GO
    
  </title>

  
  <link rel="stylesheet" href="https://xiaolong2009.github.io/css/poole.css">
  <link rel="stylesheet" href="https://xiaolong2009.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://xiaolong2009.github.io/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.proxy.ustclug.org/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xiaolong2009.github.io/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://xiaolong2009.github.io/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://xiaolong2009.github.io/feed.xml">
</head>


  <body class="theme-base-0d">

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My notes and thoughts.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="https://xiaolong2009.github.io/">Home</a>
    <a class="sidebar-nav-item " href="https://xiaolong2009.github.io/post">Posts</a>
    <a class="sidebar-nav-item " href="https://xiaolong2009.github.io/tags">Tags</a>

    
    
      
        <a class="sidebar-nav-item " href="https://xiaolong2009.github.io/about/">About</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/xiaolong2009" target="_blank">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 1. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://xiaolong2009.github.io/" title="Home">V2GO</a>
            <small>Way to Coding</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">由WSGI想到的</h1>
  <span class="post-date">Apr 11 2016</span>
  

<p>对于一个python的web项目, 在一次http请求的背后究竟发生了什么呢?今天通过这篇博客跟大家说道说道</p>

<hr />

<h2 id="背景">背景</h2>

<p>python web开发中，服务端程序程序可以分为两个部分，一是服务器程序，二是应用程序。前者负责把客户端请求接受、整理，后者负责具体逻辑处理。为了方便应用程序的开发，通常把常用的功能封装起来成为各种web开发框架，如django、flask等，这些应用程序都要跟服务器程序配合才能为用户服务。但是问题来了，服务器程序和应用程序之间怎么搭配呢？这时候就需要一个标准，只要server和web app都支持这个标准，那他们就可以配合使用，一旦标准确定，双方各自实现。这样，服务器可以支持更多支持标准的框架，框架也可以使用更多支持标准的服务器。<strong>在python web开发中,这个标准就是The Web Server Gateway Interface也就是WSGI.</strong>
<img src="https://ruslanspivak.com/lsbaws-part2/lsbaws_part2_wsgi_interop.png" alt="image" /></p>

<h2 id="wsgi-简介">WSGI 简介</h2>

<p>WSGI主要是对应用程序与服务器端的一些规定，所以，它的主要内容就分为两个部分。</p>

<h3 id="应用程序-app">应用程序(app)</h3>

<ol>
<li>app必须是一个callable对象，可以是函数，类，实现了<strong>call</strong>方法的实例对象</li>
<li>app接受2个参数environ和start_response，environ是一个包含了CGI环境变量与WSGI相关变量的字典， start_response是一个函数对象，用于处理response header，接受2个参数status是response状态码，headers是response header的列表，列表项是元组</li>

<li><p>app返回一个可迭代对象，可以是list，实现了<strong>iter</strong>方法的类，其它的可迭代对象。用于response body<br />
一个wsgi app看起来应该是这样的：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;A barebones WSGI application.</span>

<span class="sd">This is a starting point for your own Web framework :)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
<span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
<span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
<span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello world from a simple WSGI application!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">]</span>
</code></pre></div></li>
</ol>

<h3 id="服务器程序">服务器程序</h3>

<ol>
<li>把应用程序需要的两个参数设置好，这里的两个参数指的是environ和start_response</li>
<li>调用应用程序</li>

<li><p>迭代访问应用程序的返回结果，并将其传回客户端<br />
一个server看起来应该是这样的：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
<span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c"># set environ</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">write</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&#39;__len__&#39;</span><span class="p">):</span>
    <span class="c"># result must be accumulated</span>
    <span class="k">pass</span>


<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<h2 id="wsgi详解">WSGI详解</h2>

<p>看到这里相信大多数同学还是一脸懵B，下面我们来详细说一下这两个部分，按照请求到达后端的顺序，我们先从服务器程序说起</p>

<h3 id="服务器程序-1">服务器程序</h3></li>
</ol>

<p>先上代码，将下面的代码存为webserver.py</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">WSGIServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">address_family</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span>
    <span class="n">socket_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
    <span class="n">request_queue_size</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_address</span><span class="p">):</span>
        <span class="c"># Create a listening socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span> <span class="o">=</span> <span class="n">listen_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address_family</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span>
        <span class="p">)</span>
        <span class="c"># Allow to reuse the same address</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Bind</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="c"># Activate</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span><span class="p">)</span>
        <span class="c"># Get server host name and port</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="c"># Return headers set by Web framework/Web application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>

    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">listen_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># New client connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">listen_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="c"># Handle one request and close the client connection. Then</span>
            <span class="c"># loop over to wait for another client connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_one_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_data</span> <span class="o">=</span> <span class="n">request_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="c"># Print formatted request data a la &#39;curl -v&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s">&#39;&lt; {line}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">request_data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_request</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>

        <span class="c"># Construct environment dictionary using request data</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>

        <span class="c"># It&#39;s time to call our application callable and get</span>
        <span class="c"># back a result that will become HTTP response body</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>

        <span class="c"># Construct a response and send it back to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c"># Break down the request line into components</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_method</span><span class="p">,</span>  <span class="c"># GET</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>            <span class="c"># /hello</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span>  <span class="c"># HTTP/1.1</span>
         <span class="p">)</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># The following code snippet does not follow PEP8 conventions</span>
        <span class="c"># but it&#39;s formatted the way it is for demonstration purposes</span>
        <span class="c"># to emphasize the required variables and their values</span>
        <span class="c">#</span>
        <span class="c"># Required WSGI variables</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.version&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&#39;http&#39;</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_data</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multithread&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.run_once&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Required CGI variables</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_method</span>    <span class="c"># GET</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>              <span class="c"># /hello</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span>       <span class="c"># localhost</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_PORT&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>  <span class="c"># 8888</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Add necessary server headers</span>
        <span class="n">server_headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="s">&#39;Tue, 31 Mar 2015 12:54:48 GMT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="s">&#39;WSGIServer 0.2&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span> <span class="o">+</span> <span class="n">server_headers</span><span class="p">]</span>
        <span class="c"># To adhere to WSGI specification the start_response must return</span>
        <span class="c"># a &#39;write&#39; callable. We simplicity&#39;s sake we&#39;ll ignore that detail</span>
        <span class="c"># for now.</span>
        <span class="c"># return self.finish_response</span>

    <span class="k">def</span> <span class="nf">finish_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span>
            <span class="n">response</span> <span class="o">=</span> <span class="s">&#39;HTTP/1.1 {status}</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">response_headers</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="s">&#39;{0}: {1}</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="c"># Print formatted response data a la &#39;curl -v&#39;</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s">&#39;&gt; {line}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">8888</span>


<span class="k">def</span> <span class="nf">make_server</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;Provide a WSGI application object as module:callable&#39;</span><span class="p">)</span>
    <span class="n">app_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">application</span> <span class="o">=</span> <span class="n">app_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">application</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;WSGIServer: Serving HTTP on port {port} ...</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">))</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>

<p>这是一段比较完整的web server的代码，可以和django、flask等框架配置使用，下面用flask先来演示一下怎么使用，再具体分析代码的逻辑<br />
1. 先创建一个虚拟环境</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="err">$</span> <span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">virtualenv</span>
<span class="err">$</span> <span class="n">mkdir</span> <span class="o">~/</span><span class="n">envs</span>
<span class="err">$</span> <span class="n">virtualenv</span> <span class="o">~/</span><span class="n">envs</span><span class="o">/</span><span class="n">test</span><span class="o">/</span>
<span class="err">$</span> <span class="n">cd</span> <span class="o">~/</span><span class="n">envs</span><span class="o">/</span><span class="n">test</span><span class="o">/</span>
<span class="err">$</span> <span class="n">ls</span>
<span class="nb">bin</span>  <span class="n">include</span>  <span class="n">lib</span>
<span class="err">$</span> <span class="n">source</span> <span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">flask</span>
</code></pre></div>

<ol>
<li>将下面的代码存为flaskapp.py
```python
from flask import Flask
from flask import Response
flask_app = Flask(&lsquo;flaskapp&rsquo;)</li>
</ol>

<p>@flask_app.route(&lsquo;/hello&rsquo;)
def hello_world():
    return Response(
        &lsquo;Hello world from Flask!\n&rsquo;,
        mimetype=&lsquo;text/plain&rsquo;
    )</p>

<p>app = flask_app.wsgi_app</p>

<pre><code>3. 用webserver启动flaskapp
```python
(test) $ python webserver.py flaskapp:app
WSGIServer: Serving HTTP on port 8888 ...
</code></pre>

<ol>
<li>测试
在输入 <a href="http://localhost:8888/hello">http://localhost:8888/hello</a> 然后访问</li>
</ol>

<p><img src="https://ruslanspivak.com/lsbaws-part2/lsbaws_part2_browser_flask.png" alt="image" /></p>

<p>显然 我们的代码生效了</p>

<p>现在我们回过头来看一下webserver.py是怎么实现的<br />
1. 我们从flask里导入了application，application是由web 框架提供的。
2. 创建一个socket链接，然后通过socket的recv方法读取request
3. 对请求进行解析，解析的结果会有request_method、path、request_version等信息
4. 用解析出来的信息创建一个environ，environ是一个字典，里面包含了CGI环境变量和wsgi需要的一些变量
5. 调用application，并将environ和start_response传进去，然后得到一个结果
6. 解析得到的结果，并拼接出response的header和body，其中header是由start_response产生的，body是遍历application得到的。
7. 最后通过socket的sendall方法返回给客户端。
<img src="https://ruslanspivak.com/lsbaws-part2/lsbaws_part2_server_summary.png" alt="image" />
好了一次完整的请求就结束了，这里我们可以看到服务端程序主要是对请求进行解析，并拼凑出environ传递给应用程序，具体的处理流程其实应用程序那边，也就是上面的第4和第5步，那应用程序拿到environ后具体是怎么处理的呢，下面我们来详细说一下应用程序</p>

<h3 id="应用器程序">应用器程序</h3>

<p>先回顾一下一个最简单的应用程序的代码</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A barebones WSGI application.</span>

<span class="sd">    This is a starting point for your own Web framework :)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello world from a simple WSGI application!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">]</span>
</code></pre></div>

<p>大家肯定会说我写的django或者flask的代码不是这样的，这里仅仅是一个演示，没有解析environ也没有具体的处理逻辑，这里想说明的是，应用程序和服务器程序是怎样配合的。start_response是一个函数对象，用于处理response header，app返回的是一个可迭代对象，web server会遍历这个可迭代对象来产生response body。
但是在实际的web框架中可不仅仅是这么简单，一般的web框架都会实现url路由，cookie处理等等中间件。下面我们看一下一个web框架是怎么写的。</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;application.py&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">my_app</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_response</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&quot;/hello&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET_hello</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GET_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Welcome!</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">GET_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;404 Not Found&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Not Found</span><span class="se">\n</span><span class="s">&quot;</span>
</code></pre></div>

<p>从environ里读取了url的path，不同的url用不同的函数进行处理，实现了最简单的url路由的功能，但是url还是硬编码，下面用正则来匹配url</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>


<span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">my_app</span><span class="p">:</span>

    <span class="n">urls</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;/hello/(.*)&quot;</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_response</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="c"># pass the matched groups as arguments to the function</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">funcname</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">notfound</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GET_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Welcome!</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">GET_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span> 
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Hello </span><span class="si">%s</span><span class="s">!</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">notfound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;404 Not Found&#39;</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;Not Found</span><span class="se">\n</span><span class="s">&quot;</span>
</code></pre></div>

<p>消除GET<em>*方法中的重复代码，剥离出urls配置 和 GET</em>*方法</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;application.py&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">my_app</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;my simple web framework&quot;&quot;&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="o">=</span><span class="p">(),</span> <span class="n">fvars</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_urls</span> <span class="o">=</span> <span class="n">urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fvars</span> <span class="o">=</span> <span class="n">fvars</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span> <span class="c"># 默认状态OK</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[:]</span> <span class="c"># 清空上一次的headers</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">start_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

        <span class="c"># 将返回值result（字符串 或者 字符串列表）转换为迭代对象</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">([</span><span class="n">result</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_urls</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="c"># pass the matched groups as arguments to the function</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">funcname</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c"># 方法名大写（如GET、POST）</span>
                <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fvars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c"># 根据字符串名称查找类对象</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">klass</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notfound</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_notfound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s">&#39;404 Not Found&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Not Found</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;code.py&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">application</span> <span class="kn">import</span> <span class="n">my_app</span>

<span class="n">urls</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;/hello/(.*)&quot;</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">wsgiapp</span> <span class="o">=</span> <span class="n">my_app</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">index</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_app</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Welcome!</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="k">class</span> <span class="nc">hello</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">my_app</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Hello </span><span class="si">%s</span><span class="s">!</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">8086</span><span class="p">,</span> <span class="n">wsgiapp</span><span class="p">)</span>

    <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;http://{0}:{1}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span>

    <span class="c"># Respond to requests until process is killed</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>

<p>这里的web server是用了 python自带的wsgiref，有兴趣的同学可以看一下他的源码实现，看看和我们自己实现的web server有多大的区别.推荐一篇大神写的文章<br />
<a href="http://blog.csdn.net/on_1y/article/details/18818081">wsgiref 源代码分析</a></p>



</div>



    <div class="ds-thread" data-thread-key="/2016/04/11/%E7%94%B1wsgi%E6%83%B3%E5%88%B0%E7%9A%84/" data-title="由WSGI想到的" data-url="https://xiaolong2009.github.io/2016/04/11/%E7%94%B1wsgi%E6%83%B3%E5%88%B0%E7%9A%84/"></div>


<script type="text/javascript">
var duoshuoQuery = {short_name:"Xiaolong"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>



      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

